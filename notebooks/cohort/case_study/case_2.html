<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cohort Case Study 2 &mdash; Responsible AI Mitigations  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Cohort Case Study 3" href="case_3.html" />
    <link rel="prev" title="Cohort Case Study 1" href="case_1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Responsible AI Mitigations
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install_guide.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../integration_to_libs.html">How this library works with the Responsible AI Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../gallery.html">Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../gallery.html#databalanceanalysis">DataBalanceAnalysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gallery.html#dataprocessing">DataProcessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gallery.html#cohort">Cohort</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gallery.html#case-studies">Case Studies</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../gallery.html#cohort-case-studies">Cohort Case Studies</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="case_1.html">Cohort Case Study 1</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Cohort Case Study 2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Initial-analysis-of-multiple-cohort-definitions">Initial analysis of multiple cohort definitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#A-Closer-Look-at-the-“relationship”-cohorts">A Closer Look at the “relationship” cohorts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="case_3.html">Cohort Case Study 3</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../gallery.html#using-scikit-learn-s-pipeline">Using scikit-learn’s Pipeline</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../databalanceanalysis/intro.html">DataBalanceAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataprocessing/intro.html">DataProcessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cohort/intro.html">Cohort</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils/utils.html">Utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Responsible AI Mitigations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../api.html">API reference</a> &raquo;</li>
          <li><a href="../../../cohort/cohort.html">Cohort</a> &raquo;</li>
          <li><a href="../../../cohort/utils.html">Cohort Utils</a> &raquo;</li>
      <li>Cohort Case Study 2</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com//microsoft/responsible-ai-toolbox-mitigations/blob/main/docs/notebooks/cohort/case_study/case_2.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Cohort-Case-Study-2">
<h1>Cohort Case Study 2<a class="headerlink" href="#Cohort-Case-Study-2" title="Permalink to this heading"></a></h1>
<p>This notebook will follow a similar approach to what was done in the notebook <code class="docutils literal notranslate"><span class="pre">Cohort</span> <span class="pre">Case</span> <span class="pre">Study</span> <span class="pre">1</span></code>, but this time we’ll use a real dataset. Since this time we’re handling a real dataset, it might not be obvious which cohorts follow different behaviors, as we’ve seen in the aforementioned notebook.</p>
<p>We’ll start by downloading the dataset and reading the train and test sets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../notebooks&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">raimitigations.utils</span> <span class="kn">import</span> <span class="n">split_data</span>
<span class="kn">import</span> <span class="nn">raimitigations.dataprocessing</span> <span class="k">as</span> <span class="nn">dp</span>
<span class="kn">from</span> <span class="nn">raimitigations.cohort</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CohortDefinition</span><span class="p">,</span>
    <span class="n">CohortManager</span><span class="p">,</span>
    <span class="n">fetch_cohort_results</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">download</span> <span class="kn">import</span> <span class="n">download_datasets</span>

<span class="n">SEED</span> <span class="o">=</span> <span class="mi">46</span>
<span class="c1">#SEED = None</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;../../../datasets/census/&quot;</span>
<span class="n">download_datasets</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="n">label_col</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s2">&quot;train.csv&quot;</span><span class="p">)</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s2">&quot;test.csv&quot;</span><span class="p">)</span>
<span class="c1"># convert to 0 and 1 encoding</span>
<span class="n">df_train</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&lt;=50K&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df_test</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&lt;=50K&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">label_col</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">label_col</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(32561, 15)
(16281, 15)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>income</th>
      <th>age</th>
      <th>workclass</th>
      <th>fnlwgt</th>
      <th>education</th>
      <th>education-num</th>
      <th>marital-status</th>
      <th>occupation</th>
      <th>relationship</th>
      <th>race</th>
      <th>gender</th>
      <th>capital-gain</th>
      <th>capital-loss</th>
      <th>hours-per-week</th>
      <th>native-country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>39</td>
      <td>State-gov</td>
      <td>77516</td>
      <td>Bachelors</td>
      <td>13</td>
      <td>Never-married</td>
      <td>Adm-clerical</td>
      <td>Not-in-family</td>
      <td>White</td>
      <td>Male</td>
      <td>2174</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>50</td>
      <td>Self-emp-not-inc</td>
      <td>83311</td>
      <td>Bachelors</td>
      <td>13</td>
      <td>Married-civ-spouse</td>
      <td>Exec-managerial</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>13</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>38</td>
      <td>Private</td>
      <td>215646</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Divorced</td>
      <td>Handlers-cleaners</td>
      <td>Not-in-family</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>53</td>
      <td>Private</td>
      <td>234721</td>
      <td>11th</td>
      <td>7</td>
      <td>Married-civ-spouse</td>
      <td>Handlers-cleaners</td>
      <td>Husband</td>
      <td>Black</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>28</td>
      <td>Private</td>
      <td>338409</td>
      <td>Bachelors</td>
      <td>13</td>
      <td>Married-civ-spouse</td>
      <td>Prof-specialty</td>
      <td>Wife</td>
      <td>Black</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>Cuba</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>32556</th>
      <td>0</td>
      <td>27</td>
      <td>Private</td>
      <td>257302</td>
      <td>Assoc-acdm</td>
      <td>12</td>
      <td>Married-civ-spouse</td>
      <td>Tech-support</td>
      <td>Wife</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>38</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>32557</th>
      <td>1</td>
      <td>40</td>
      <td>Private</td>
      <td>154374</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Machine-op-inspct</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>32558</th>
      <td>0</td>
      <td>58</td>
      <td>Private</td>
      <td>151910</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Widowed</td>
      <td>Adm-clerical</td>
      <td>Unmarried</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>32559</th>
      <td>0</td>
      <td>22</td>
      <td>Private</td>
      <td>201490</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Never-married</td>
      <td>Adm-clerical</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>20</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>32560</th>
      <td>1</td>
      <td>52</td>
      <td>Self-emp-inc</td>
      <td>287927</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Exec-managerial</td>
      <td>Wife</td>
      <td>White</td>
      <td>Female</td>
      <td>15024</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
  </tbody>
</table>
<p>32561 rows × 15 columns</p>
</div></div>
</div>
<p>Here we define which model will be used throughout the experiments performed here. Remember that our goal is not to compare different models, but instead to compare different approaches to cohort processing. Therefore, we’ll use the same model for all experiments, but we’ll alternate between training a pipeline using the entire dataset and training multiple pipelines, where each pipeline is associated with a specific cohort. We’ll also see how the cohort definition changes the results obtained.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
    <span class="c1">#model = LogisticRegression()</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
<section id="Initial-analysis-of-multiple-cohort-definitions">
<h2>Initial analysis of multiple cohort definitions<a class="headerlink" href="#Initial-analysis-of-multiple-cohort-definitions" title="Permalink to this heading"></a></h2>
<p>Now that we have our dataset, we can create a simple pipeline and fit it using the training data. We’ll then use the <code class="docutils literal notranslate"><span class="pre">fetch_cohort_results</span></code> function to show the results obtained for the entire dataset, as well as for different cohorts. Notice that this function computes all metrics for each cohort separately, and therefore, different thresholds might be encountered for each cohort (the optimal threshold of a given set of predictions is found using the ROC curve).</p>
<section id="Superficial-analysis-of-the-“race”-cohorts">
<h3>Superficial analysis of the “race” cohorts<a class="headerlink" href="#Superficial-analysis-of-the-“race”-cohorts" title="Permalink to this heading"></a></h3>
<p>Our first analysis will focus on the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">race</span></code> feature.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;estimator&quot;</span><span class="p">,</span> <span class="n">get_model</span><span class="p">()),</span>
        <span class="p">])</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_org</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_org</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.928045</td>
      <td>0.774041</td>
      <td>0.846508</td>
      <td>0.793006</td>
      <td>0.828082</td>
      <td>0.214291</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`race` == " Amer-Indian-Eskimo")</td>
      <td>0.964286</td>
      <td>0.760706</td>
      <td>0.916541</td>
      <td>0.807547</td>
      <td>0.893082</td>
      <td>0.236285</td>
      <td>159</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`race` == " Asian-Pac-Islander")</td>
      <td>0.904596</td>
      <td>0.777669</td>
      <td>0.830903</td>
      <td>0.789716</td>
      <td>0.812500</td>
      <td>0.209811</td>
      <td>480</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`race` == " Black")</td>
      <td>0.950497</td>
      <td>0.706862</td>
      <td>0.886423</td>
      <td>0.744534</td>
      <td>0.846252</td>
      <td>0.098247</td>
      <td>1561</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`race` == " Other")</td>
      <td>0.980000</td>
      <td>0.895238</td>
      <td>0.952727</td>
      <td>0.920085</td>
      <td>0.948148</td>
      <td>0.176354</td>
      <td>135</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`race` == " White")</td>
      <td>0.924495</td>
      <td>0.776855</td>
      <td>0.840369</td>
      <td>0.793715</td>
      <td>0.824896</td>
      <td>0.235332</td>
      <td>13946</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let’s now create a separate pipeline for the different cohorts, instead of training a single pipeline for the entire dataset. We’ll accomplish this by using the <code class="docutils literal notranslate"><span class="pre">CohortManager</span></code> class. We’ll then compare the results obtained for the same cohorts tested in the previous cell. In this notebook, just like in <code class="docutils literal notranslate"><span class="pre">Cohort</span> <span class="pre">Case</span> <span class="pre">Study</span> <span class="pre">1</span></code>, we’ll call this approach the cohort-based pipeline, and we’ll try different cohort-based pipelines, each time using different cohort definitions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.919545</td>
      <td>0.769716</td>
      <td>0.839667</td>
      <td>0.788366</td>
      <td>0.824765</td>
      <td>0.212255</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`race` == " Amer-Indian-Eskimo")</td>
      <td>0.722932</td>
      <td>0.578701</td>
      <td>0.683083</td>
      <td>0.471853</td>
      <td>0.522013</td>
      <td>0.003494</td>
      <td>159</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`race` == " Asian-Pac-Islander")</td>
      <td>0.881606</td>
      <td>0.763607</td>
      <td>0.809787</td>
      <td>0.775563</td>
      <td>0.802083</td>
      <td>0.133196</td>
      <td>480</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`race` == " Black")</td>
      <td>0.920955</td>
      <td>0.675330</td>
      <td>0.858043</td>
      <td>0.699228</td>
      <td>0.804612</td>
      <td>0.022147</td>
      <td>1561</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`race` == " Other")</td>
      <td>0.826545</td>
      <td>0.670588</td>
      <td>0.763636</td>
      <td>0.676923</td>
      <td>0.740741</td>
      <td>0.006283</td>
      <td>135</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`race` == " White")</td>
      <td>0.924379</td>
      <td>0.772555</td>
      <td>0.841171</td>
      <td>0.788055</td>
      <td>0.817510</td>
      <td>0.212255</td>
      <td>13946</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Notice that using a separate pipeline for each cohort defined by the <code class="docutils literal notranslate"><span class="pre">race</span></code> column is not a good idea: we got considerably worse results for some cohorts compared to the baseline pipeline. This might mean that, for some cohorts (like cohort <code class="docutils literal notranslate"><span class="pre">cohort_0</span></code>), we have insufficient data for training a separate model for that cohort, and that the data from other cohorts indeed helps the end result. This could also mean that these cohorts share similarities to other cohorts, and that is why using data
from different cohorts to train a single model is better than training a separate model for each cohort.</p>
</section>
<section id="Superficial-analysis-of-the-“gender”-cohorts">
<h3>Superficial analysis of the “gender” cohorts<a class="headerlink" href="#Superficial-analysis-of-the-“gender”-cohorts" title="Permalink to this heading"></a></h3>
<p>Let’s now try other cohort definitions and see if we can find some scenario where the model underperforms for a given cohort. Our next test is to check the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">gender</span></code> column. We’ll follow the same procedure: first, we train a single pipeline over the entire dataset, followed by an evaluation of the predictions over the test data separated by each cohort. Once again, the metrics are computed separately for the predictions of each cohort, and therefore, we might see
different optimal threshold values encountered for different cohorts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_org</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.928045</td>
      <td>0.774041</td>
      <td>0.846508</td>
      <td>0.793006</td>
      <td>0.828082</td>
      <td>0.214291</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`gender` == " Female")</td>
      <td>0.945489</td>
      <td>0.697068</td>
      <td>0.866671</td>
      <td>0.734840</td>
      <td>0.848552</td>
      <td>0.077829</td>
      <td>5421</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`gender` == " Male")</td>
      <td>0.910614</td>
      <td>0.780929</td>
      <td>0.821125</td>
      <td>0.790895</td>
      <td>0.809761</td>
      <td>0.284180</td>
      <td>10860</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Next, we create different pipelines for each cohort and evaluate the predictions made by the ensemble of models over each cohort separately.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.924731</td>
      <td>0.771722</td>
      <td>0.841294</td>
      <td>0.790623</td>
      <td>0.826976</td>
      <td>0.224417</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`gender` == " Female")</td>
      <td>0.939232</td>
      <td>0.726703</td>
      <td>0.867672</td>
      <td>0.769103</td>
      <td>0.880834</td>
      <td>0.100605</td>
      <td>5421</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`gender` == " Male")</td>
      <td>0.908182</td>
      <td>0.784077</td>
      <td>0.818615</td>
      <td>0.794710</td>
      <td>0.815838</td>
      <td>0.306261</td>
      <td>10860</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Analyzing the two previous results, we can notice that there isn’t a considerable difference in the metrics for each of the cohorts. Also, training different pipelines for each cohort didn’t manage to improve the performance, just like our previous results. Therefore, it seems that the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">gender</span></code> column follow similar behaviors, so we won’t be able to gain a lot using different pipelines for each cohort in this case.</p>
</section>
<section id="Superficial-analysis-of-the-“relationship”-cohorts">
<h3>Superficial analysis of the “relationship” cohorts<a class="headerlink" href="#Superficial-analysis-of-the-“relationship”-cohorts" title="Permalink to this heading"></a></h3>
<p>We now analyze the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> column. Let’s see the results of the baseline pipeline over each of these cohorts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_org</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.928045</td>
      <td>0.774041</td>
      <td>0.846508</td>
      <td>0.793006</td>
      <td>0.828082</td>
      <td>0.214291</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.851455</td>
      <td>0.767644</td>
      <td>0.760808</td>
      <td>0.762712</td>
      <td>0.767745</td>
      <td>0.496800</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.903658</td>
      <td>0.648626</td>
      <td>0.823863</td>
      <td>0.672058</td>
      <td>0.806685</td>
      <td>0.078964</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.936405</td>
      <td>0.574932</td>
      <td>0.890196</td>
      <td>0.588954</td>
      <td>0.849524</td>
      <td>0.034834</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.933263</td>
      <td>0.545761</td>
      <td>0.884905</td>
      <td>0.540163</td>
      <td>0.839634</td>
      <td>0.011240</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.908060</td>
      <td>0.597355</td>
      <td>0.833168</td>
      <td>0.610507</td>
      <td>0.811793</td>
      <td>0.054493</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.873899</td>
      <td>0.792793</td>
      <td>0.794374</td>
      <td>0.793273</td>
      <td>0.794233</td>
      <td>0.492120</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>As we can see, in this case, we do have some cohorts that have considerably worse results than others. For example, cohorts <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code>, <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>, and <code class="docutils literal notranslate"><span class="pre">cohort_4</span></code> have considerably lower F1 scores than the other cohorts. This could be a problem if the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> column is considered a sensitive feature, where a similar performance is expected for all cohorts. In that case, we’ll see if we can improve the metrics for these cohorts using different pipelines for each cohort, similar to
what we’ve done in the previous experiments:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.921740</td>
      <td>0.774480</td>
      <td>0.838504</td>
      <td>0.793696</td>
      <td>0.831767</td>
      <td>0.235577</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.847310</td>
      <td>0.768719</td>
      <td>0.761313</td>
      <td>0.763310</td>
      <td>0.768511</td>
      <td>0.496186</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.894365</td>
      <td>0.652406</td>
      <td>0.815078</td>
      <td>0.679824</td>
      <td>0.819542</td>
      <td>0.076893</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.904314</td>
      <td>0.574198</td>
      <td>0.862745</td>
      <td>0.591053</td>
      <td>0.859048</td>
      <td>0.000759</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.908999</td>
      <td>0.600146</td>
      <td>0.849079</td>
      <td>0.646560</td>
      <td>0.944688</td>
      <td>0.000762</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.872706</td>
      <td>0.603854</td>
      <td>0.799634</td>
      <td>0.629067</td>
      <td>0.846337</td>
      <td>0.030138</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.830681</td>
      <td>0.749464</td>
      <td>0.751278</td>
      <td>0.748091</td>
      <td>0.748362</td>
      <td>0.438196</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Notice that this time, training different pipelines for the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> column resulted in considerable improvements in some cohorts, while also attaining slightly worse results in other cohorts. We can see that the F1 score for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code> got improved, but at the same time, for this same cohort, the AUC ROC went down a bit. For <code class="docutils literal notranslate"><span class="pre">cohort_5</span></code>, the AUC ROC and F1 scores were lower when training different pipelines. This might indicate that training a separate model
for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code> and another model for the remaining cohorts might result in a better result. We’ll explore this in the following cells.</p>
</section>
</section>
<section id="A-Closer-Look-at-the-“relationship”-cohorts">
<h2>A Closer Look at the “relationship” cohorts<a class="headerlink" href="#A-Closer-Look-at-the-“relationship”-cohorts" title="Permalink to this heading"></a></h2>
<p>In this section, we’ll take a closer look at how we can try to improve the results for the cohorts defined by the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> column. As we’ve shown, this set of cohorts does present some considerably different metrics between different cohorts. Here we’ll try using different cohort definitions, and data rebalancing to improve the performance over a set of cohorts.</p>
<p>Before starting the analysis, we’ll create a function for plotting the label distribution over different cohorts. This will be useful when we start looking at data imbalance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="k">def</span> <span class="nf">plot_value_counts_cohort</span><span class="p">(</span><span class="n">y_full</span><span class="p">,</span> <span class="n">subsets</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#plt.legend(bbox_to_anchor=(1.02, 1), loc=&#39;upper left&#39;, borderaxespad=0, fontsize=23)</span>

    <span class="n">value_count</span> <span class="o">=</span> <span class="n">y_full</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>

    <span class="n">subsets_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full df&#39;</span><span class="p">,</span> <span class="s1">&#39;full df&#39;</span><span class="p">]</span>
    <span class="n">counts_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">label_col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subsets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">value_count</span> <span class="o">=</span> <span class="n">subsets</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
        <span class="n">subsets_col</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>
        <span class="n">counts_col</span> <span class="o">+=</span> <span class="p">[</span><span class="n">value_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">label_col</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;subsets&quot;</span><span class="p">:</span><span class="n">subsets_col</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="n">label_col</span><span class="p">,</span> <span class="s2">&quot;counts&quot;</span><span class="p">:</span><span class="n">counts_col</span><span class="p">})</span>

    <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Occurrences&quot;</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Fraction&quot;</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;subsets&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">count_df</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Subsets&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="c1">#ax.tick_params(labelsize=15)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We can now look at the label distribution over each of the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> cohorts using the function previously defined (with the help of the <code class="docutils literal notranslate"><span class="pre">CohortManager</span></code> class):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cohort_set</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cohort_set</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">subsets</span> <span class="o">=</span> <span class="n">cohort_set</span><span class="o">.</span><span class="n">get_subsets</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subsets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">subsets</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">***********&quot;</span><span class="p">)</span>

<span class="n">plot_value_counts_cohort</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">subsets</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0    24720
1     7841
Name: income, dtype: int64

cohort_0:
0    7275
1    5918
Name: income, dtype: int64
***********

cohort_1:
0    7449
1     856
Name: income, dtype: int64
***********

cohort_2:
0    944
1     37
Name: income, dtype: int64
***********

cohort_3:
0    5001
1      67
Name: income, dtype: int64
***********

cohort_4:
0    3228
1     218
Name: income, dtype: int64
***********

cohort_5:
0    823
1    745
Name: income, dtype: int64
***********
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_cohort_case_study_case_2_21_1.png" src="../../../_images/notebooks_cohort_case_study_case_2_21_1.png" />
</div>
</div>
<section id="Rebalancing-the-entire-dataset">
<h3>Rebalancing the entire dataset<a class="headerlink" href="#Rebalancing-the-entire-dataset" title="Permalink to this heading"></a></h3>
<p>Let’s start by using a simple rebalance strategy using the <code class="docutils literal notranslate"><span class="pre">Rebalance</span></code> class over the entire dataset. We then plot the new label distributions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rebalance</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span> <span class="o">=</span> <span class="n">rebalance</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">cohort_set</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">new_y_train</span><span class="p">)</span>
<span class="n">subsets</span> <span class="o">=</span> <span class="n">cohort_set</span><span class="o">.</span><span class="n">get_subsets</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">new_y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subsets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">subsets</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">***********&quot;</span><span class="p">)</span>

<span class="n">plot_value_counts_cohort</span><span class="p">(</span><span class="n">new_y_train</span><span class="p">,</span> <span class="n">subsets</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0    24720
1    24720
Name: income, dtype: int64

cohort_0:
1    21603
0     7275
Name: income, dtype: int64
***********

cohort_1:
0    7449
1    1423
Name: income, dtype: int64
***********

cohort_2:
0    944
1     40
Name: income, dtype: int64
***********

cohort_3:
0    5001
1      77
Name: income, dtype: int64
***********

cohort_4:
0    3228
1     238
Name: income, dtype: int64
***********

cohort_5:
1    1339
0     823
Name: income, dtype: int64
***********
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_cohort_case_study_case_2_23_1.png" src="../../../_images/notebooks_cohort_case_study_case_2_23_1.png" />
</div>
</div>
<p>Notice that the label distribution became imbalanced towards the opposite class in <code class="docutils literal notranslate"><span class="pre">cohort_0</span></code> after rebalancing. Let’s now use the baseline pipeline with the rebalanced dataset and check the results for the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> cohorts:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;estimator&quot;</span><span class="p">,</span> <span class="n">get_model</span><span class="p">()),</span>
        <span class="p">])</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">)</span>
<span class="n">pred_org</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_org</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.921874</td>
      <td>0.765679</td>
      <td>0.836890</td>
      <td>0.783717</td>
      <td>0.819974</td>
      <td>0.285999</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.835034</td>
      <td>0.750890</td>
      <td>0.750629</td>
      <td>0.750755</td>
      <td>0.753488</td>
      <td>0.605171</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.899895</td>
      <td>0.684344</td>
      <td>0.829142</td>
      <td>0.722082</td>
      <td>0.860215</td>
      <td>0.138539</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.953791</td>
      <td>0.586376</td>
      <td>0.901961</td>
      <td>0.612290</td>
      <td>0.872381</td>
      <td>0.045129</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.932081</td>
      <td>0.557454</td>
      <td>0.874103</td>
      <td>0.572312</td>
      <td>0.884202</td>
      <td>0.017004</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.903355</td>
      <td>0.583324</td>
      <td>0.828068</td>
      <td>0.574734</td>
      <td>0.762954</td>
      <td>0.042936</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.861501</td>
      <td>0.782269</td>
      <td>0.784459</td>
      <td>0.781979</td>
      <td>0.782438</td>
      <td>0.548571</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>As expected, we didn’t have a considerable improvement for some cohorts. For example, let’s focus here on <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>, which presented considerably worse results when compared to the other cohorts when using the baseline pipeline over the original dataset. For this cohort, after rebalancing, the baseline pipeline resulted in inferior precision and recall metrics when compared to the results obtained by the baseline pipeline trained over the original dataset. This makes sense because only a very
small number of instances were created for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code> after the rebalancing operation, which is a result of how SMOTE works. Therefore, we now have a greater imbalance in the number of instances in each cohort, which may result in inferior results for these minority cohorts.</p>
<p>We’ll now try using the cohort-based pipeline over the rebalanced dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.917939</td>
      <td>0.777103</td>
      <td>0.834813</td>
      <td>0.796039</td>
      <td>0.836005</td>
      <td>0.339383</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.831617</td>
      <td>0.742007</td>
      <td>0.744544</td>
      <td>0.741650</td>
      <td>0.742450</td>
      <td>0.537313</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.900655</td>
      <td>0.662199</td>
      <td>0.810464</td>
      <td>0.694328</td>
      <td>0.838008</td>
      <td>0.106587</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.905359</td>
      <td>0.593400</td>
      <td>0.879412</td>
      <td>0.627154</td>
      <td>0.891429</td>
      <td>0.001583</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.918816</td>
      <td>0.606111</td>
      <td>0.872008</td>
      <td>0.655795</td>
      <td>0.945881</td>
      <td>0.000918</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.881868</td>
      <td>0.597508</td>
      <td>0.817802</td>
      <td>0.614191</td>
      <td>0.821918</td>
      <td>0.021182</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.835875</td>
      <td>0.760932</td>
      <td>0.761051</td>
      <td>0.760990</td>
      <td>0.762779</td>
      <td>0.594278</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The results shown above depict a similar scenario to the previous results (baseline pipeline over the rebalanced dataset): an improvement over some cohorts and performance reduction for other cohorts. Once again, this is because a different number of data points were added to each cohort, due to the nature of the SMOTE rebalancing technique (used in the <code class="docutils literal notranslate"><span class="pre">Rebalance</span></code> class).</p>
</section>
<section id="Rebalancing-only-a-few-cohorts">
<h3>Rebalancing only a few cohorts<a class="headerlink" href="#Rebalancing-only-a-few-cohorts" title="Permalink to this heading"></a></h3>
<p>Let’s try to mitigate these issues by rebalancing only a few cohorts because as we’ve seen in the label distribution of the original dataset, only a few cohorts have a serious label imbalance. This way, we’ll try to improve the results of only a few cohorts. In the following cell, we use the <code class="docutils literal notranslate"><span class="pre">Rebalance</span></code> class together with the <code class="docutils literal notranslate"><span class="pre">CohortManager</span></code> in order to rebalance only cohorts <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code> and <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c0_pipe</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">c1_pipe</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">c2_pipe</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">(</span><span class="n">strategy_over</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">c3_pipe</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Rebalance</span><span class="p">(</span><span class="n">strategy_over</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">c4_pipe</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">c5_pipe</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">rebalance_cohort</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span><span class="n">c0_pipe</span><span class="p">,</span> <span class="n">c1_pipe</span><span class="p">,</span> <span class="n">c2_pipe</span><span class="p">,</span> <span class="n">c3_pipe</span><span class="p">,</span> <span class="n">c4_pipe</span><span class="p">,</span> <span class="n">c5_pipe</span><span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span> <span class="o">=</span> <span class="n">rebalance_cohort</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">subsets</span> <span class="o">=</span> <span class="n">rebalance_cohort</span><span class="o">.</span><span class="n">get_subsets</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">,</span> <span class="n">apply_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plot_value_counts_cohort</span><span class="p">(</span><span class="n">new_y_train</span><span class="p">,</span> <span class="n">subsets</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_cohort_case_study_case_2_29_0.png" src="../../../_images/notebooks_cohort_case_study_case_2_29_0.png" />
</div>
</div>
<p>We’ll now repeat the same experiments as before. We’ll first train the baseline pipeline over the new rebalanced dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;encoder&quot;</span><span class="p">,</span> <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;estimator&quot;</span><span class="p">,</span> <span class="n">get_model</span><span class="p">()),</span>
        <span class="p">])</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">)</span>
<span class="n">pred_org</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_org</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.922955</td>
      <td>0.766493</td>
      <td>0.839125</td>
      <td>0.784462</td>
      <td>0.820097</td>
      <td>0.243259</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.849175</td>
      <td>0.770341</td>
      <td>0.759717</td>
      <td>0.762100</td>
      <td>0.768358</td>
      <td>0.513855</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.900467</td>
      <td>0.657451</td>
      <td>0.818966</td>
      <td>0.687095</td>
      <td>0.826554</td>
      <td>0.131611</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.949020</td>
      <td>0.585294</td>
      <td>0.900980</td>
      <td>0.610194</td>
      <td>0.870476</td>
      <td>0.111778</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.920128</td>
      <td>0.552481</td>
      <td>0.858689</td>
      <td>0.562234</td>
      <td>0.875846</td>
      <td>0.076464</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.905372</td>
      <td>0.576866</td>
      <td>0.816418</td>
      <td>0.558062</td>
      <td>0.740917</td>
      <td>0.040851</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.870593</td>
      <td>0.786184</td>
      <td>0.787654</td>
      <td>0.786651</td>
      <td>0.787680</td>
      <td>0.489399</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Once again, we did get improvements for some cohorts, and performance reduction for others. Let’s try using the cohort-based pipeline over this new rebalanced dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_X_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.921497</td>
      <td>0.772831</td>
      <td>0.837936</td>
      <td>0.791930</td>
      <td>0.829802</td>
      <td>0.235577</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.847310</td>
      <td>0.768719</td>
      <td>0.761313</td>
      <td>0.763310</td>
      <td>0.768511</td>
      <td>0.496186</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.894365</td>
      <td>0.652406</td>
      <td>0.815078</td>
      <td>0.679824</td>
      <td>0.819542</td>
      <td>0.076893</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.888235</td>
      <td>0.595128</td>
      <td>0.851961</td>
      <td>0.631201</td>
      <td>0.900952</td>
      <td>0.006322</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.902776</td>
      <td>0.536897</td>
      <td>0.839271</td>
      <td>0.518907</td>
      <td>0.815758</td>
      <td>0.001906</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.872706</td>
      <td>0.603854</td>
      <td>0.799634</td>
      <td>0.629067</td>
      <td>0.846337</td>
      <td>0.030138</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.830681</td>
      <td>0.749464</td>
      <td>0.751278</td>
      <td>0.748091</td>
      <td>0.748362</td>
      <td>0.438196</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let’s compare this last results with the results obtained by using the cohort-base pipeline over the original dataset: by using the rebalanced dataset, we managed to improve the performance for <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code>, but we suffered a performance reduction for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>. This shows us that we must always carefully analyze how the rebalancing process affects each cohort separately. In the following sections, we’ll take a closer look at how we can improve the results for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>, since rebalancing
didn’t work very well for this cohort (although rebalancing worked fine for <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code>).</p>
</section>
<section id="Looking-at-“cohort_3”,-where-“relationship”-==-“Own-child”">
<h3>Looking at “cohort_3”, where “relationship” == “Own-child”<a class="headerlink" href="#Looking-at-“cohort_3”,-where-“relationship”-==-“Own-child”" title="Permalink to this heading"></a></h3>
<p>Let’s try training a cohort-based pipeline for the following cohorts: cohort where <code class="docutils literal notranslate"><span class="pre">relationship</span></code> == “Own-child”, and another cohort for the remaining instances. We’ll try this approach because we noticed that training a separate pipeline for <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code> did improve its metrics, but the same doesn’t apply to the other cohorts, that is, the other cohorts benefit by using data from different cohorts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c0</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39; Own-child&#39;</span><span class="p">]]</span> <span class="p">]</span>
<span class="n">c1</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_def</span><span class="o">=</span><span class="p">[</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.926455</td>
      <td>0.774861</td>
      <td>0.844373</td>
      <td>0.794105</td>
      <td>0.830170</td>
      <td>0.226182</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.851043</td>
      <td>0.771036</td>
      <td>0.760570</td>
      <td>0.762947</td>
      <td>0.769125</td>
      <td>0.513947</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.904380</td>
      <td>0.663575</td>
      <td>0.820838</td>
      <td>0.695773</td>
      <td>0.835671</td>
      <td>0.097639</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.956732</td>
      <td>0.573529</td>
      <td>0.914706</td>
      <td>0.581581</td>
      <td>0.834286</td>
      <td>0.027224</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.908999</td>
      <td>0.600146</td>
      <td>0.849079</td>
      <td>0.646560</td>
      <td>0.944688</td>
      <td>0.000762</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.907919</td>
      <td>0.606513</td>
      <td>0.826619</td>
      <td>0.630507</td>
      <td>0.838594</td>
      <td>0.065474</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.871434</td>
      <td>0.800143</td>
      <td>0.797383</td>
      <td>0.798401</td>
      <td>0.800786</td>
      <td>0.530978</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>If we compare the results above with the results obtained with the cohort-base pipeline (using the <code class="docutils literal notranslate"><span class="pre">relationship</span></code> cohorts) over the original dataset, we can see that the former has the best metrics for almost all cohorts. This is because some cohorts work well together, while others (in this case, <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>) perform better if trained separately. And thanks to the <code class="docutils literal notranslate"><span class="pre">CohortManager</span></code>, we managed to do this.</p>
<p>We still haven’t managed to improve the results for <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code>. Similar to what happened to <code class="docutils literal notranslate"><span class="pre">cohort_3</span></code>, we can test which cohorts work well with <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code> and which don’t, that is, which cohorts can be trained together, and which cohorts that when trained together result in sub-optimal metrics. After experimenting with a few combinations, we found out that <code class="docutils literal notranslate"><span class="pre">cohort_1</span></code> and <code class="docutils literal notranslate"><span class="pre">cohort_2</span></code> worked well together: if we train a separate pipeline for a cohort comprised of all instances where
<code class="docutils literal notranslate"><span class="pre">relationship</span></code> is either “Not-in-family” or “Unmarried”, then we manage to improve the metrics for these two cohorts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c0</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39; Own-child&#39;</span><span class="p">]]</span> <span class="p">]</span>
<span class="n">c1</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39; Not-in-family&#39;</span><span class="p">,</span> <span class="s1">&#39; Unmarried&#39;</span><span class="p">]]</span> <span class="p">]</span>
<span class="n">c2</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">cht_manager</span> <span class="o">=</span> <span class="n">CohortManager</span><span class="p">(</span>
    <span class="n">transform_pipe</span><span class="o">=</span><span class="p">[</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">DataStandardScaler</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">dp</span><span class="o">.</span><span class="n">EncoderOHE</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unknown_err</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">get_model</span><span class="p">()</span>
    <span class="p">],</span>
    <span class="n">cohort_def</span><span class="o">=</span><span class="p">[</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">cht_manager</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">pred_cht</span> <span class="o">=</span> <span class="n">cht_manager</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">fetch_cohort_results</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">pred_cht</span><span class="p">,</span> <span class="n">cohort_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cohort</th>
      <th>cht_query</th>
      <th>roc</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>accuracy</th>
      <th>threshold</th>
      <th>cht_size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>all</td>
      <td>all</td>
      <td>0.925274</td>
      <td>0.778632</td>
      <td>0.842644</td>
      <td>0.798186</td>
      <td>0.835759</td>
      <td>0.249491</td>
      <td>16281</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cohort_0</td>
      <td>(`relationship` == " Husband")</td>
      <td>0.848288</td>
      <td>0.760762</td>
      <td>0.759740</td>
      <td>0.760192</td>
      <td>0.763146</td>
      <td>0.453393</td>
      <td>6523</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cohort_1</td>
      <td>(`relationship` == " Not-in-family")</td>
      <td>0.903614</td>
      <td>0.662846</td>
      <td>0.824587</td>
      <td>0.694509</td>
      <td>0.832866</td>
      <td>0.086289</td>
      <td>4278</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cohort_2</td>
      <td>(`relationship` == " Other-relative")</td>
      <td>0.907974</td>
      <td>0.614483</td>
      <td>0.861765</td>
      <td>0.660477</td>
      <td>0.920000</td>
      <td>0.078535</td>
      <td>525</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cohort_3</td>
      <td>(`relationship` == " Own-child")</td>
      <td>0.908999</td>
      <td>0.600146</td>
      <td>0.849079</td>
      <td>0.646560</td>
      <td>0.944688</td>
      <td>0.000762</td>
      <td>2513</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cohort_4</td>
      <td>(`relationship` == " Unmarried")</td>
      <td>0.903362</td>
      <td>0.598105</td>
      <td>0.818432</td>
      <td>0.615314</td>
      <td>0.823109</td>
      <td>0.050977</td>
      <td>1679</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cohort_5</td>
      <td>(`relationship` == " Wife")</td>
      <td>0.876226</td>
      <td>0.794176</td>
      <td>0.796462</td>
      <td>0.793824</td>
      <td>0.794233</td>
      <td>0.472902</td>
      <td>763</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="case_1.html" class="btn btn-neutral float-left" title="Cohort Case Study 1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="case_3.html" class="btn btn-neutral float-right" title="Cohort Case Study 3" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Microsoft.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>