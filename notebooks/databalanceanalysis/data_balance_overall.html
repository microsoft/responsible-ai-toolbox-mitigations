<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Python Data Balance Analysis &mdash; Responsible AI Mitigations  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="End to End Data Balance and Error Mitigation" href="../data_balance_e2e.html" />
    <link rel="prev" title="Data Balance Analysis using the Adult Census Income dataset" href="data_balance_census.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Responsible AI Mitigations
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install_guide.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration_to_libs.html">How this library works with the Responsible AI Toolbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../gallery.html">Gallery</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../gallery.html#databalanceanalysis">DataBalanceAnalysis</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="data_balance_census.html">Data Balance Analysis using the Adult Census Income dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="data_balance_census.html#Summary​">Summary​</a></li>
<li class="toctree-l3"><a class="reference internal" href="data_balance_census.html#Analysis:">Analysis:</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Python Data Balance Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example-Notebook">Example Notebook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Explanations-of-Data-Balance-Measures">Explanations of Data Balance Measures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Feature-Balance-Measures">Feature Balance Measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Distribution-Balance-Measures">Distribution Balance Measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Aggregate-Balance-Measures">Aggregate Balance Measures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Mitigation">Mitigation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Resampling">Resampling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Reweighting">Reweighting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../data_balance_e2e.html">End to End Data Balance and Error Mitigation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../gallery.html#dataprocessing">DataProcessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gallery.html#case-studies">Case Studies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gallery.html#using-scikit-learn-s-pipeline">Using scikit-learn’s Pipeline</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../databalanceanalysis/intro.html">DataBalanceAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataprocessing/intro.html">DataProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Responsible AI Mitigations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../gallery.html">Gallery</a> &raquo;</li>
      <li>Python Data Balance Analysis</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com//microsoft/responsible-ai-toolbox-mitigations/blob/main/docs/notebooks/databalanceanalysis/data_balance_overall.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Python-Data-Balance-Analysis">
<h1>Python Data Balance Analysis<a class="headerlink" href="#Python-Data-Balance-Analysis" title="Permalink to this heading"></a></h1>
</section>
<section id="Context">
<h1>Context<a class="headerlink" href="#Context" title="Permalink to this heading"></a></h1>
<p>Data Balance Analysis is relevant for the overall understanding of datasets, but is essential to building Machine Learning models in a responsible way, especially in term of fairness. It is all too easy to build an ML Model that produces biased results for subsets of the population by training or testing the model on biased ground truth data. There are multiple case studies of biased models assisting in granting loans healthcare, recruitment opportunities and many other decision-making tasks. In
most of these examples, the data on which these models are trained was the common issue. These findings emphasize how important it is for model creators and auditors to analyze data balance: - to measure training data across various sub-populations - to ensure the data has good coverage, and a balanced representation of labels across sensitive categories and category combinations - and to check that the test data is representative of the target population</p>
<p>In summary, Data Balance Analysis has the following benefits when used for building ML models. - Reduces the risk of unbalanced models by: - ensuring service fairness and reducing the costs of ML building by identifying data representation gaps early on - prompting data scientists to seek mitigation steps before proceeding on the training portion of Machine Learning model development - Enables easy end-to-end debugging of ML systems in combination with Fairlearn by providing a clear view if an
issue in a model is tied to the data or the model itself.</p>
</section>
<section id="Usage">
<h1>Usage<a class="headerlink" href="#Usage" title="Permalink to this heading"></a></h1>
<p>Data Balance Analysis supports three different types of metrics. - FeatureMeasures - supervised (requires a label column) - DistributionMeasures - unsupervised (does not require a label column) - AggregateMeasures - unsupervised (does not require a label column)</p>
</section>
<section id="Example-Notebook">
<h1>Example Notebook<a class="headerlink" href="#Example-Notebook" title="Permalink to this heading"></a></h1>
<p>[Adult Census Income Dataset] ()</p>
<ol class="arabic simple">
<li><p>First we import all of the classes we are interested in.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../notebooks&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">raimitigations.databalanceanalysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FeatureBalanceMeasure</span><span class="p">,</span>
    <span class="n">DistributionBalanceMeasure</span><span class="p">,</span>
    <span class="n">AggregateBalanceMeasure</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">download</span> <span class="kn">import</span> <span class="n">download_datasets</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Load the dataset, define the features of interest and ensure that the label column is binary. Currently, the FeatureBalance measure calculator only supports binary labels.</p></li>
</ol>
<p>For example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s2">&quot;../../datasets/&quot;</span>
<span class="n">download_datasets</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s2">&quot;AdultCensusIncome.csv&quot;</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sensitive_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gender&quot;</span><span class="p">,</span> <span class="s2">&quot;Race&quot;</span><span class="p">]</span>
<span class="n">label_col</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>

<span class="c1"># convert to 0 and 1 encoding</span>
<span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&lt;=50K&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Create an instance of the FeatureMeasure class and set the sensitives to the column you are interested in seeing and the label column to the name of the column of interest.</p></li>
</ol>
<p>For example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols_of_interest</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]</span>
<span class="n">label_col</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
<span class="n">feature_measures</span> <span class="o">=</span> <span class="n">FeatureBalanceMeasure</span><span class="p">(</span><span class="n">cols_of_interest</span><span class="p">,</span> <span class="n">label_col</span><span class="p">)</span>
<span class="n">feat_measures</span> <span class="o">=</span> <span class="n">feature_measures</span><span class="o">.</span><span class="n">measures</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="4">
<li><p>Create an instance of the DistributionMeasures class and set the sensitive columns to the columns you are interested in seeing.</p></li>
</ol>
<p>For example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">distribution_measures</span> <span class="o">=</span> <span class="n">DistributionBalanceMeasure</span><span class="p">([</span><span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])</span>
<span class="n">distribution_measures</span><span class="o">.</span><span class="n">measures</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FeatureName</th>
      <th>kl_divergence</th>
      <th>js_dist</th>
      <th>wasserstein_dist</th>
      <th>inf_norm_dist</th>
      <th>total_variation_dist</th>
      <th>chi_sq_p_value</th>
      <th>chi_sq_stat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>race</td>
      <td>1.055793</td>
      <td>0.510400</td>
      <td>0.261709</td>
      <td>0.654274</td>
      <td>0.654274</td>
      <td>0.0</td>
      <td>87941.889193</td>
    </tr>
    <tr>
      <th>1</th>
      <td>sex</td>
      <td>0.058407</td>
      <td>0.121735</td>
      <td>0.169205</td>
      <td>0.169205</td>
      <td>0.169205</td>
      <td>0.0</td>
      <td>3728.950616</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Create an instance of the AggregateMeasures class and set the sensitive columns parameter to the columns of interest.</p></li>
</ol>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&lt;=50K&quot;</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">aggregate_measures</span> <span class="o">=</span> <span class="n">AggregateBalanceMeasure</span><span class="p">([</span><span class="s2">&quot;race&quot;</span><span class="p">])</span>
<span class="n">aggregate_measures</span><span class="o">.</span><span class="n">measures</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>theil_l_index</th>
      <th>theil_t_index</th>
      <th>atkinson_index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.4678</td>
      <td>1.055793</td>
      <td>0.769568</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Explanations-of-Data-Balance-Measures">
<h1>Explanations of Data Balance Measures<a class="headerlink" href="#Explanations-of-Data-Balance-Measures" title="Permalink to this heading"></a></h1>
<section id="Feature-Balance-Measures">
<h2>Feature Balance Measures<a class="headerlink" href="#Feature-Balance-Measures" title="Permalink to this heading"></a></h2>
<p>Feature Balance Measures allow us to see whether each combination of sensitive feature is receiving the positive outcome (true prediction) at balanced probability.</p>
<p>In this context, we define a feature balance measure, also referred to as the parity, for label y as the difference between the association metrics of two different sensitive classes <span class="math notranslate nohighlight">\(([x_A, x_B])\)</span>, with respect to the association metric <span class="math notranslate nohighlight">\((A(x_i, y))\)</span>. That is:</p>
<div class="math notranslate nohighlight">
\[parity(y \vert x_A, x_B, A(\cdot)) \coloneqq A(x_A, y) - A(x_B, y)\]</div>
<p>Using the dataset, we can see if the various sexes and races are receiving &gt;50k income at equal or unequal rates.</p>
<p>Note: Many of these metrics were influenced by this paper <a class="reference external" href="https://arxiv.org/abs/2103.03417">Measuring Model Biases in the Absence of Ground Truth.</a></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Association Metric</p></th>
<th class="head"><p>Family</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Interpretation</p></th>
<th class="head"><p>Reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Demographic Parity</p></td>
<td><p>Fairness</p></td>
<td><p>Proportion of each segment of a protected class (e.g. gender) should receive the positive outcome
at equal rates.</p></td>
<td><p>As close to 0 means better parity. <span class="math notranslate nohighlight">\((DP = P(Y \vert A = Male) - P(Y \vert A = Female))\)</span>. Y
= Positive label rate.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Fairness_%28machine_learning%29">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Pointwise Mutual Information (PMI), normalized PMI</p></td>
<td><p>Entropy</p></td>
<td><p>The PMI of a pair of feature values (ex: Gender=Male and Gender=Female) quantifies the
discrepancy between the probability of their coincidence given their joint distribution and their
individual distributions (assuming independence).</p></td>
<td><p>Range (normalized) [-1, 1]. -1 for no co-occurences. 0 for co-occurences at random. 1 for
complete co-occurences.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Pointwise_mutual_information">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>Sorensen-Dice Coefficient (SDC)</p></td>
<td><p>Intersection-over-Union</p></td>
<td><p>Union Used to gauge the similarity of two samples. Related to F1 score.</p></td>
<td><p>Equals twice the number of elements common to both sets divided by the sum of the number of
elements in each set.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/S%C3%B8rensen%E2%80%93Dice_coefficient">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Jaccard Index</p></td>
<td><p>Intersection-over-Union</p></td>
<td><p>Similar to SDC, guages the similarity and diversity of sample sets.</p></td>
<td><p>Equals the size of the intersection divided by the size of the union of the sample sets.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Jaccard_index">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>Kendall Rank Correlation</p></td>
<td><p>Correlation and Statistical Tests</p></td>
<td><p>Used to measure the ordinal association between two measured quantities.</p></td>
<td><p>High when observations have a similar rank and low when observations have a dissimilar rank
between the two variables.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Log-Likelihood Ratio</p></td>
<td><p>Correlation and Statistical Tests</p></td>
<td><p>Statistical Tests Calculates the degree to which data supports one variable versus another. Log
of the likelihood ratio, which gives the probability of correctly predicting the label in ratio
to probability of incorrectly predicting label.</p></td>
<td><p>If likelihoods are similar, it should be close to 0.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Likelihood_function#Likelihood_ratio">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>t-test</p></td>
<td><p>Correlation and Statistical Tests</p></td>
<td><p>Used to compare the means of two groups (pairwise).</p></td>
<td><p>Value looked up in t-Distribution tell if statistically significant or not.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Student's_t-test">Link</a></p></td>
</tr>
</tbody>
</table>
</section>
<section id="Distribution-Balance-Measures">
<h2>Distribution Balance Measures<a class="headerlink" href="#Distribution-Balance-Measures" title="Permalink to this heading"></a></h2>
<p>Distribution Balance Measures allow us to compare our data with a reference distribution (currently only uniform distribution is supported as a reference distribution). They are calculated per sensitive column and do not depend on the label column.</p>
<p>For example, let’s assume we have a dataset with 9 rows and a Gender column, and we observe that:</p>
<ul class="simple">
<li><p>“Male” appears 4 times</p></li>
<li><p>“Female” appears 3 times</p></li>
<li><p>“Other” appears 2 times</p></li>
</ul>
<p>Assuming the uniform distribution:</p>
<div class="math notranslate nohighlight">
\[ReferenceCount \coloneqq  \frac{numRows}{numFeatureValues}\]</div>
<div class="math notranslate nohighlight">
\[ReferenceProbability \coloneqq  \frac{1}{numFeatureValues}\]</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Feature Value</p></th>
<th class="head"><p>Observed Count</p></th>
<th class="head"><p>Reference Count</p></th>
<th class="head"><p>Observed Probability</p></th>
<th class="head"><p>Reference Probabiliy</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Male</p></td>
<td><p>4</p></td>
<td><p>9/3 = 3</p></td>
<td><p>4/9 = 0.44</p></td>
<td><p>3/9 = 0.33</p></td>
</tr>
<tr class="row-odd"><td><p>Female</p></td>
<td><p>3</p></td>
<td><p>9/3 = 3</p></td>
<td><p>3/9 = 0.33</p></td>
<td><p>3/9 = 0.33</p></td>
</tr>
<tr class="row-even"><td><p>Other</p></td>
<td><p>2</p></td>
<td><p>9/3 = 3</p></td>
<td><p>2/9 = 0.22</p></td>
<td><p>3/9 = 0.33</p></td>
</tr>
</tbody>
</table>
<p>We can use distance measures to find out how far our observed and reference distributions of these feature values are. Some of these distance measures include:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Measure</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Interpretation</p></th>
<th class="head"><p>Reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>KL Divergence</p></td>
<td><p>Measure of how one probability distribution is different from a second, reference probability distribution. Measure of the
information gained when one revises one’s beliefs from the prior probability distribution Q to the posterior probability
distribution P. In other words, it is the amount of information lost when Q is used to approximate P.</p></td>
<td><p>Non-negative. 0 means P = Q.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Jenson-Shannon Distance</p></td>
<td><p>Measuring the similarity between two probability distributions. Symmetrized and smoothed version of the Kullback–Leibler
(KL) divergence. Square root of Jenson-Shannon Divergence.</p></td>
<td><p>Range [0, 1]. 0 means perfectly same to balanced distribution.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Jensen%E2%80%93Shannon_divergence">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>Wasserstein Distance</p></td>
<td><p>This distance is also known as the earth mover’s distance, since it can be seen as the minimum amount of “work” required
to transform u into v, where “work” is measured as the amount of distribution weight that must be moved, multiplied by the
distance it has to be moved.</p></td>
<td><p>Non-negative. 0 means P = Q.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Wasserstein_metric">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Infinity Norm Distance</p></td>
<td><p>Distance between two vectors is the greatest of their differences along any coordinate dimension. Also called Chebyshev
distance or chessboard distance.</p></td>
<td><p>Non-negative. 0 means same distribution.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Chebyshev_distance">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>Total Variation Distance</p></td>
<td><p>It is equal to half the L1 (Manhattan) distance between the two distributions. Take the difference between the two
proportions in each category, add up the absolute values of all the differences, and then divide the sum by 2.</p></td>
<td><p>Non-negative. 0 means same distribution.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Total_variation_distance_of_probability_measures">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Chi-Squared Test</p></td>
<td><p>The chi-square test tests the null hypothesis that the categorical data has the given frequencies given expected
frequencies in each category.</p></td>
<td><p>p-value gives evidence against null-hypothesis that difference in observed and expected frequencies is by random chance.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Chi-squared_test">Link</a></p></td>
</tr>
</tbody>
</table>
</section>
<section id="Aggregate-Balance-Measures">
<h2>Aggregate Balance Measures<a class="headerlink" href="#Aggregate-Balance-Measures" title="Permalink to this heading"></a></h2>
<p>Aggregate Balance Measures allow us to obtain a higher notion of inequality. They are calculated on the set of all sensitive columns and do not depend on the label column.</p>
<p>These measures look at distribution of records across all combinations of sensitive columns. For example, if Sex and Race are specified as sensitive features, it then tries to quantify imbalance across all combinations of the two specified features - (Male, Black), (Female, White), (Male, Asian-Pac-Islander), etc.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Measure</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Interpretation</p></th>
<th class="head"><p>Reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Atkinson Index</p></td>
<td><p>It presents the percentage of total income that a given society would have to forego in order to have more equal shares of
income between its citizens. This measure depends on the degree of society aversion to inequality (a theoretical parameter
decided by the researcher), where a higher value entails greater social utility or willingness by individuals to accept
smaller incomes in exchange for a more equal distribution. An important feature of the Atkinson index is that it can be
decomposed into within-group and between-group inequality.</p></td>
<td><p>Range [0, 1]. 0 if perfect equality. 1 means maximum inequality. In our case, it is the proportion of records for a
sensitive columns’ combination.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Atkinson_index">Link</a></p></td>
</tr>
<tr class="row-odd"><td><p>Theil T Index</p></td>
<td><p>GE(1) = Theil’s T and is more sensitive to differences at the top of the distribution. The Theil index is a statistic used
to measure economic inequality. The Theil index measures an entropic “distance” the population is away from the “ideal”
egalitarian state of everyone having the same income.</p></td>
<td><p>If everyone has the same income, then T_T equals 0. If one person has all the income, then T_T gives the result (ln N). 0
means equal income and larger values mean higher level of disproportion.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Theil_index">Link</a></p></td>
</tr>
<tr class="row-even"><td><p>Theil L Index</p></td>
<td><p>GE(0) = Theil’s L and is more sensitive to differences at the lower end of the distribution. Logarithm of (mean
income)/(income i), over all the incomes included in the summation. It is also referred to as the mean log deviation
measure. Because a transfer from a larger income to a smaller one will change the smaller income’s ratio more than it
changes the larger income’s ratio, the transfer-principle is satisfied by this index.</p></td>
<td><p>Same interpretation as Theil T Index.</p></td>
<td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Theil_index">Link</a></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="Mitigation">
<h1>Mitigation<a class="headerlink" href="#Mitigation" title="Permalink to this heading"></a></h1>
<p>It will not be a stretch to say that every real-world dataset has caveats, biases, and imbalances. Data collection is costly. Data Imbalance mitigation or de-biasing data is an area of research. There are many techniques available at various stages of ML lifecycle i.e., during pre-processing, in-processing, and post processing. Here we outline a couple of pre-processing techniques -</p>
<section id="Resampling">
<h2>Resampling<a class="headerlink" href="#Resampling" title="Permalink to this heading"></a></h2>
<p>This involves under-sampling from majority class and over-sampling from minority class. Most naïve way to over-sample would be duplicate records and under-sample would be to remove records at random.</p>
<ul class="simple">
<li><p>Caveats:</p>
<ol class="arabic simple">
<li><p>Under-sampling may remove valuable information.</p></li>
<li><p>Over-sampling may cause overfitting and poor generalization on test set.</p></li>
</ol>
</li>
</ul>
<p><img alt="Bar chart undersampling and oversampling" src="https://mmlspark.blob.core.windows.net/graphics/responsible_ai/DataBalanceAnalysis_SamplingBar.png" /></p>
<p>There are smarter techniques to under-sample and over-sample in literature and implemented in Python’s <a class="reference external" href="https://imbalanced-learn.org/stable/">imbalanced-learn</a> package.</p>
<p>For example, we can cluster the records of the majority class, and do the under-sampling by removing records from each cluster, thus seeking to preserve information.</p>
<p>One technique of under-sampling is use of Tomek Links. Tomek links are pairs of very close instances but of opposite classes. Removing the instances of the majority class of each pair increases the space between the two classes, facilitating the classification process. A similar way to under-sample majority class is using Near-Miss. It first calculates the distance between all the points in the larger class with the points in the smaller class. When two points belonging to different classes are
very close to each other in the distribution, this algorithm eliminates the datapoint of the larger class thereby trying to balance the distribution.</p>
<p><img alt="Tomek Links" src="https://mmlspark.blob.core.windows.net/graphics/responsible_ai/DataBalanceAnalysis_TomekLinks.png" /></p>
<p>In over-sampling, instead of creating exact copies of the minority class records, we can introduce small variations into those copies, creating more diverse synthetic samples. This technique is called SMOTE (Synthetic Minority Oversampling Technique). It randomly picks a point from the minority class and computes the k-nearest neighbors for this point. The synthetic points are added between the chosen point and its neighbors.</p>
<p><img alt="Synthetic Samples" src="https://mmlspark.blob.core.windows.net/graphics/responsible_ai/DataBalanceAnalysis_SyntheticSamples.png" /></p>
</section>
<section id="Reweighting">
<h2>Reweighting<a class="headerlink" href="#Reweighting" title="Permalink to this heading"></a></h2>
<p>There is an expected and observed value in each table cell. The weight is essentially expected / observed value. This is easy to extend to multiple features with more than 2 groups. The weights are then incorporated in loss function of model training.</p>
<p><img alt="Reweighting" src="https://mmlspark.blob.core.windows.net/graphics/responsible_ai/DataBalanceAnalysis_Reweight.png" /></p>
<p>Source: This notebook is adaptation of this notebook in the SynapseML documentation <a class="reference external" href="https://microsoft.github.io/SynapseML/docs/features/responsible_ai/Data%20Balance%20Analysis/">https://microsoft.github.io/SynapseML/docs/features/responsible_ai/Data%20Balance%20Analysis/</a> written by Kashyap Patel</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="data_balance_census.html" class="btn btn-neutral float-left" title="Data Balance Analysis using the Adult Census Income dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../data_balance_e2e.html" class="btn btn-neutral float-right" title="End to End Data Balance and Error Mitigation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Microsoft.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>